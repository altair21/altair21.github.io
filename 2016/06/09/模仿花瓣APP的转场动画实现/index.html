<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 模仿花瓣APP的转场动画实现 · altair21的学习笔记</title><meta name="description" content="模仿花瓣APP的转场动画实现 - altair21"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://note.altair21.org/atom.xml" title="altair21的学习笔记"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/avatar.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">首页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">关于</a></li><li class="nav-list-item"><a href="/books" target="_self" class="nav-list-link">书单</a></li><li class="nav-list-item"><a href="https://github.com/altair21" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">模仿花瓣APP的转场动画实现</h1><div class="post-info">2016年6月9日</div><div class="post-content"><hr>
<h3 id="2016-11-30更新"><a href="#2016-11-30更新" class="headerlink" title="2016.11.30更新"></a><font color="red">2016.11.30更新</font></h3><p>最近在看 Raywenderlich 的动画书，碰巧看到了一样的转场动画。我新写了一篇<a href="https://note.altair21.org/2016/12/01/iOS%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BD%AC%E5%9C%BA%E5%8A%A8%E7%94%BB/">文章</a>介绍正常的做法。</p>
<p>然后根据这段时间的积累，我优化了一下之前的代码，具体请看看正文部分。</p>
<hr>
<h2 id="动画效果"><a href="#动画效果" class="headerlink" title="动画效果"></a>动画效果</h2><p>花瓣APP的转场动画比较有意思，我第一次看到就喜欢上了，为了美化自己毕业设计的游戏APP，我模仿了这个动画效果，花瓣APP的动画效果是这样的：<br><img src="https://ws2.sinaimg.cn/large/0060lm7Tgw1f4pc8bjddyg30a90hxnpe.gif" alt=""></p>
<p>这是我自己模仿的动画效果：<br><img src="https://ws4.sinaimg.cn/large/0060lm7Tgw1f4pda0lk6sg30m00glu0z.gif" alt=""></p>
<p>其实效果还可以，不流畅是gif图的问题。</p>
<a id="more"></a>
<h2 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h2><p>我的思路是点击视图时给该视图截图，生成UIImage，然后在0.4秒的时间内把这个图片放大到全屏幕（即转场后的视图的初始模样），动画效果结束的回调中放置真正的转场逻辑。</p>
<p>我的思路就是这样，感觉比较简单，有个问题是我截图之后图片放大材质会失真，转场后的场景是Spritekit的GameScene，重新加载了材质，就清晰很多，在它们衔接的时候会明显感觉到材质变清晰了，这个问题我没有去解决它，可能因为我比较粗的原因。不过回退的转场动画是从第二个视图截的图，不会有材质失真的问题。<br>Spritekit场景下截图参考了<a href="http://yulingtianxia.com/blog/2014/04/22/spritekitjie-ping-bing-fen-xiang-zhi-she-jiao-wang-luo/" target="_blank" rel="external">这篇文章</a>。</p>
<p>附上核心代码</p>
<p>UIView截图</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//UIGraphicsBeginImageContext(self.previewZone.bounds.size) // 低清晰度</span></div><div class="line"><span class="type">UIGraphicsBeginImageContextWithOptions</span>(<span class="keyword">self</span>.previewZone.bounds.size, <span class="literal">false</span>, <span class="number">0.0</span>)    <span class="comment">// 高清晰度</span></div><div class="line"><span class="keyword">self</span>.previewZone.layer.renderInContext(<span class="type">UIGraphicsGetCurrentContext</span>()!)</div><div class="line"><span class="keyword">let</span> image = <span class="type">UIGraphicsGetImageFromCurrentImageContext</span>()</div><div class="line"><span class="type">UIGraphicsEndImageContext</span>()</div><div class="line"><span class="keyword">self</span>.superView.imageDic[<span class="keyword">self</span>.fileName!] = image</div></pre></td></tr></table></figure>
<p>动画效果</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//topPanel是gif中顶部的黑色View，image就是存放截图的UIImageView</span></div><div class="line"><span class="keyword">self</span>.view.addSubview(topPanel)</div><div class="line"><span class="keyword">self</span>.view.addSubview(image)</div><div class="line"><span class="type">UIApplication</span>.sharedApplication().beginIgnoringInteractionEvents()</div><div class="line"><span class="type">UIView</span>.animateWithDuration(<span class="number">0.4</span>, animations: &#123;</div><div class="line">    image.frame = <span class="type">CGRect</span>(x: <span class="number">0</span>, y: <span class="number">64</span>, width: <span class="number">1024</span>, height: <span class="number">704</span>)</div><div class="line">    topPanel.frame = <span class="type">CGRect</span>(x: <span class="number">0</span>, y: <span class="number">0</span>, width: <span class="number">1024</span>, height: <span class="number">64</span>)</div><div class="line">    topPanel.alpha = <span class="number">1</span></div><div class="line">&#125;) &#123; (res) <span class="keyword">in</span></div><div class="line">    image.removeFromSuperview()</div><div class="line">    topPanel.removeFromSuperview()</div><div class="line">    <span class="keyword">self</span>.navigationController?.pushViewController(vc, animated: <span class="literal">false</span>)</div><div class="line">    <span class="type">UIApplication</span>.sharedApplication().endIgnoringInteractionEvents()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>动画部分是可以优化的，用变形(<code>transform</code>)替代尺寸(<code>frame</code>)可以让细节更加平滑一些</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//topPanel是gif中顶部的黑色View，image就是存放截图的UIImageView，尺寸为最终全屏时的尺寸</span></div><div class="line">image.transform = <span class="type">CGAffineTransform</span>(scaleX: imageCurrentFrame.size.width / screenWidth, y: imageCurrentFrame.size.height / screenHeight)</div><div class="line">image.center = <span class="type">CGPoint</span>(x: imageCurrentFrame.midX, y: imageCurrentFrame.midY)</div><div class="line"></div><div class="line">topPanel.transform = <span class="type">CGAffineTransform</span>(scaleX: panelCurrentFrame.size.width / screenWidth, y: panelCurrentFrame.size.height / screenHeight)</div><div class="line">topPanel.center = <span class="type">CGPoint</span>(x: panelCurrentFrame.midX, y: panelCurrentFrame.midY)</div><div class="line"></div><div class="line"><span class="keyword">self</span>.view.addSubview(topPanel)</div><div class="line"><span class="keyword">self</span>.view.addSubview(image)</div><div class="line"><span class="type">UIApplication</span>.sharedApplication().beginIgnoringInteractionEvents()</div><div class="line"><span class="type">UIView</span>.animateWithDuration(<span class="number">0.4</span>, animations: &#123;</div><div class="line">    image.transform = <span class="type">CGAffineTransform</span>.identity</div><div class="line">    image.center = <span class="type">CGPoint</span>(x: imageFinalFrame.midX, y: imageFinalFrame.midY)</div><div class="line">    topPanel.transform = <span class="type">CGAffineTransform</span>.identity</div><div class="line">    topPanel.center = <span class="type">CGPoint</span>(x: panelFinalFrame.midX, y: panelFinalFrame.midY)</div><div class="line">    topPanel.alpha = <span class="number">1</span></div><div class="line">&#125;) &#123; (res) <span class="keyword">in</span></div><div class="line">    image.removeFromSuperview()</div><div class="line">    topPanel.removeFromSuperview()</div><div class="line">    <span class="keyword">self</span>.navigationController?.pushViewController(vc, animated: <span class="literal">false</span>)</div><div class="line">    <span class="type">UIApplication</span>.sharedApplication().endIgnoringInteractionEvents()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Spritekit场景中截图</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">imageFromSKNode</span><span class="params">(node: SKNode)</span></span> -&gt; <span class="type">UIImage</span> &#123;</div><div class="line">    <span class="keyword">let</span> view = node.scene?.view</div><div class="line">    <span class="keyword">let</span> scale = <span class="type">UIScreen</span>.mainScreen().scale</div><div class="line">    <span class="keyword">let</span> nodeFrame = node.calculateAccumulatedFrame()</div><div class="line">    </div><div class="line">    <span class="type">UIGraphicsBeginImageContextWithOptions</span>(view!.bounds.size, <span class="literal">true</span>, <span class="number">0</span>)</div><div class="line">    view?.drawViewHierarchyInRect(view!.bounds, afterScreenUpdates: <span class="literal">true</span>)</div><div class="line">    <span class="keyword">let</span> sceneSnapshot = <span class="type">UIGraphicsGetImageFromCurrentImageContext</span>()</div><div class="line">    <span class="type">UIGraphicsEndImageContext</span>()</div><div class="line">    </div><div class="line">    <span class="keyword">let</span> originY = sceneSnapshot.size.height*scale - nodeFrame.origin.y*scale - nodeFrame.size.height*scale</div><div class="line">    <span class="keyword">let</span> cropRect = <span class="type">CGRect</span>(x: node.frame.origin.x * scale,</div><div class="line">                          y: originY,</div><div class="line">                          width: node.frame.size.width * scale,</div><div class="line">                          height: node.frame.size.height * scale)</div><div class="line">    <span class="keyword">let</span> croppedSnapshot = <span class="type">CGImageCreateWithImageInRect</span>(sceneSnapshot.<span class="type">CGImage</span>, cropRect)</div><div class="line">    <span class="keyword">let</span> nodeSnapshot = <span class="type">UIImage</span>(<span class="type">CGImage</span>: croppedSnapshot!)</div><div class="line">    </div><div class="line">    <span class="comment">//retain屏幕的rect</span></div><div class="line">    <span class="keyword">let</span> resRect = <span class="type">CGRect</span>(x: <span class="number">0</span>, y: <span class="number">128</span>, width: <span class="number">2048</span>, height: <span class="number">1408</span>)</div><div class="line">    <span class="keyword">let</span> resCGSnapshot = <span class="type">CGImageCreateWithImageInRect</span>(nodeSnapshot.<span class="type">CGImage</span>, resRect)</div><div class="line">    <span class="keyword">let</span> resSnapshot = <span class="type">UIImage</span>(<span class="type">CGImage</span>: resCGSnapshot!)</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> resSnapshot</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/2016/06/19/iOS中实现图片拉伸/" class="prev">上一篇</a><a href="/2016/05/16/我的毕业设计/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'altair21-note';
var disqus_identifier = '2016/06/09/模仿花瓣APP的转场动画实现/';
var disqus_title = '模仿花瓣APP的转场动画实现';
var disqus_url = 'http://note.altair21.org/2016/06/09/模仿花瓣APP的转场动画实现/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//altair21-note.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2018 <a href="http://note.altair21.org">altair21</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-56273068-4",'auto');ga('send','pageview');</script></body></html>