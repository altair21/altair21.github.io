<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 记一个iOS开发中cell的重用机制引发的错误 · altair21的学习笔记</title><meta name="description" content="记一个iOS开发中cell的重用机制引发的错误 - altair21"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://note.altair21.org/atom.xml" title="altair21的学习笔记"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/avatar.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">首页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">关于</a></li><li class="nav-list-item"><a href="/books" target="_self" class="nav-list-link">书单</a></li><li class="nav-list-item"><a href="https://github.com/altair21" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">记一个iOS开发中cell的重用机制引发的错误</h1><div class="post-info">Dec 12, 2015</div><div class="post-content"><h2 id="Cell_u7684_u91CD_u7528_u673A_u5236"><a href="#Cell_u7684_u91CD_u7528_u673A_u5236" class="headerlink" title="Cell的重用机制"></a>Cell的重用机制</h2><p>　　在iOS开发中，cell有重用机制可以减少不必要的内存开销，对应于tableViewCell的dequeueReusableCellWithIdentifier方法，和collectionViewCell的dequeueReusableCellWithReuseIdentifier方法。重用机制更多内容不在这里做介绍。
　　</p>
<h2 id="u6211_u9047_u5230_u7684_u95EE_u9898"><a href="#u6211_u9047_u5230_u7684_u95EE_u9898" class="headerlink" title="我遇到的问题"></a>我遇到的问题</h2><p>　　<br>　　做实习项目时遇到的，现在有一个关注人列表，类似微博里那种，我在follow或者unfollow一个人的时候，会给网络发一个请求来刷新服务器数据，这段时间转一了一个菊花，我遇到的bug表现如下图所示<br>　　<img src="https://ws3.sinaimg.cn/large/0060lm7Tgw1f80a36nfgjj30r80933zm.jpg" alt=""><br>　　<br>　　　　从图中可以看出，前两个button表现正常，第四个button点的时候菊花转在了第二个cell处，第三个button点击时在第一个cell那里闪了一下，应该是转了只不过这次网络请求callback太快没有看到，它的问题和第四个button一样。经过我多次测试发现，每一次第一次点击button的时候菊花都不会转错，但是从点击第二个button开始菊花位置就不能保证了。这个地方很奇怪，经验告诉我应该是重用机制造成的问题，但是我没有滚屏，按理说不应该进入到重用队列。</p>
<p>　　随后我又在网上搜了一下重用机制，看到一个我之前不知道的：<font color="red">reloadData之后屏幕上的cell都进入重用队列，再重新重用。</font></p>
<p>　　我进一步测试发现，如果每次点完按钮，再多等几秒钟，就不会出现菊花错位的问题，于是我找到了问题所在，我在第一个网络请求callback之后，又发了第二个网络请求，而那个请求的callback会刷新这个collectionView，即调用这个collectionView的reloadData方法，而我之所以要添加第二个网络请求，是为了修复另一个bug ，:-)。如果你想知道为什么reloadData之后菊花还会转，那是因为我加了一个标记。</p>
<p>　　现在原因明确了，我点击第X的button时，第X-1个button发送的第二个网络请求还没有callback，等到它callback时刷新了collectionView，cell重用了，于是菊花跑偏了。所以等一段时间再点button不会出现这个问题，这段时间刚好是前一个button第二个网络请求callback回来。所以第一个button点的时候从来没有问题。</p>
<p>　　经此一役，我加深了对cell重用机制的了解和理解。希望这篇文章对你也能有帮助:-)　　</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/01/08/githug攻略(1~55)/" class="prev">上一篇</a><a href="/2015/12/01/记一个耍了我两天的iOS布局问题/" class="next">下一篇</a></div><div data-thread-key="2015/12/12/记一个iOS开发中cell的重用机制引发的错误/" data-title="记一个iOS开发中cell的重用机制引发的错误" data-url="http://note.altair21.org/2015/12/12/记一个iOS开发中cell的重用机制引发的错误/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"altair21note"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2014 - 2016 <a href="http://note.altair21.org">altair21</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-56273068-4",'auto');ga('send','pageview');</script></body></html>